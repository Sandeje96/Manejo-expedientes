{% extends 'base.html' %}
{% block title %}Expediente {{ item.nro_expediente_cpim or item.id }} â€” CPIM{% endblock %}
{% block content %}

<style>
/* ===== Paleta (consistente con vistas anteriores) ===== */
:root{
  --primary-blue-90: hsl(220,100%,90%);
  --primary-blue-80: hsl(220,100%,80%);
  --primary-blue-70: hsl(220,100%,70%);
  --primary-blue-60: hsl(220,100%,60%);
  --primary-blue-55: hsl(220,100%,55%);
  --primary-blue-50: hsl(220,100%,50%);
  --primary-blue-40: hsl(220,100%,40%);
  --primary-blue-30: hsl(220,100%,30%);
  --primary-blue-20: hsl(220,100%,20%);
  --ink-900:#0b1220; --ink-700:#22314d; --ink-500:#475569; --ink-300:#9aa3b2;
  --card-br: rgba(69,123,255,.18);
  --chip-br: rgba(69,123,255,.35);
  --row-border: rgba(25, 60, 180, .22);
  --row-hover: rgba(25, 60, 180, .07);
}

/* ===== Hero ===== */
.hero{
  position:relative;
  background:
    radial-gradient(1200px 400px at 10% -10%, rgba(69,123,255,.18), transparent 60%),
    linear-gradient(135deg, var(--primary-blue-90), #ffffff);
  border:1px solid var(--card-br);
  border-radius: 24px;
  padding: 1.2rem 1.2rem 1rem 1.2rem;
  margin-bottom: 1rem;
  box-shadow: 0 18px 42px rgba(69,123,255,.08);
}
.hero .title{
  display:flex; align-items:center; gap:.75rem; margin:0;
  color:var(--primary-blue-20); font-weight:900; letter-spacing:.2px;
}
.hero .title::before{
  content:""; width:12px; height:28px; border-radius:12px;
  background: linear-gradient(180deg, var(--primary-blue-60), var(--primary-blue-40));
  box-shadow:0 6px 18px rgba(69,123,255,.35);
}
.hero .meta{
  display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.6rem;
}
.badge-soft{
  display:inline-flex; align-items:center; gap:.4rem;
  padding:.35rem .65rem; border-radius:999px; font-weight:800; font-size:.85rem;
  background: linear-gradient(180deg, #f7faff, #eef4ff);
  border:1px solid var(--chip-br); color:var(--primary-blue-20);
}
.badge-soft.success{ background:#ecfdf5; border-color:#bbf7d0; color:#166534; }
.badge-soft.warn{ background:#fff7ed; border-color:#fed7aa; color:#92400e; }
.badge-soft.gray{ background:#f2f4f7; border-color:#e6e9ef; color:#475569; }
.badge-soft.info{ background:#eef2ff; border-color:#c7d2fe; color:#3730a3; }

/* ===== Barra de acciones ===== */
.actions-bar{
  display:flex; align-items:center; gap:.5rem; flex-wrap:wrap;
}
.btn-strong{
  background:linear-gradient(135deg,var(--primary-blue-55),var(--primary-blue-40));
  border:none; color:#fff; padding:.45rem .7rem; border-radius:12px;
  font-weight:800; font-size:.9rem; box-shadow:0 10px 22px rgba(69,123,255,.25);
}
.btn-strong:hover{ transform:translateY(-1px); color:#fff; filter:brightness(.98); }
.btn-outline{
  border:2px solid var(--primary-blue-55); color:var(--primary-blue-20); background:#fff;
  padding:.4rem .65rem; border-radius:12px; font-weight:800; font-size:.9rem;
}
.btn-outline:hover{ background:var(--primary-blue-90); }

/* ===== Cards mÃ©tricas ===== */
.metric-grid{
  display:grid; gap: .8rem;
  grid-template-columns: repeat(4, minmax(0,1fr));
}
.metric{
  position:relative; overflow:hidden;
  background: rgba(255,255,255,.92);
  backdrop-filter: blur(8px);
  border:1px solid var(--card-br); border-radius:18px;
  box-shadow:0 18px 42px rgba(69,123,255,.08);
}
.metric::after{
  content:""; position:absolute; inset:0;
  background: radial-gradient(400px 120px at 90% -10%, rgba(69,123,255,.12), transparent 60%);
  pointer-events:none;
}
.metric .body{ padding:.9rem; text-align:center; }
.metric .value{
  font-size:1.8rem; line-height:1; font-weight:900; letter-spacing:.2px;
}
.metric.info .value{ color:#0ea5e9; }
.metric.warn .value{ color:#f59e0b; }
.metric.gray .value{ color:#6b7280; }
.metric.good .value{ color:#16a34a; }
.metric small{ color:var(--ink-500); }

/* ===== Timeline ===== */
.timeline-wrap{
  background:#fff; border:1px solid var(--card-br); border-radius:18px;
  box-shadow:0 18px 42px rgba(69,123,255,.08);
  padding:1rem;
}
.timeline{
  position:relative; margin-left: .25rem;
}
.timeline-item{ position:relative; padding-left: 3.25rem; }
.timeline-item + .timeline-item{ margin-top: .75rem; }
.marker{
  position:absolute; left:.4rem; top:.45rem; width:34px; height:34px; border-radius:50%;
  display:flex; align-items:center; justify-content:center; color:#fff; font-size:16px;
  box-shadow:0 6px 14px rgba(0,0,0,.15);
}
.marker.info{ background:#0ea5e9; }     /* CPIM */
.marker.warn{ background:#f59e0b; }     /* IMLAUER */
.marker.gray{ background:#6b7280; }     /* ONETTO */
.marker.good{ background:#16a34a; }     /* PROFESIONAL */
.vline{
  position:absolute; left:1.05rem; top:34px; bottom:-6px; width:2px;
  background: linear-gradient(180deg, #e6ebff, transparent);
}
.tcard{
  background: linear-gradient(180deg, #f8faff, #ffffff);
  border:1px solid var(--card-br); border-radius:14px; padding:.6rem .75rem;
}
.trow{ display:grid; grid-template-columns: 1.2fr .9fr .9fr .6fr; gap:.6rem; align-items:center; }
@media (max-width: 992px){
  .trow{ grid-template-columns: 1fr; gap:.4rem; }
}

/* ===== Detalles (tabla) ===== */
.card-glass{
  background: rgba(255,255,255,.95);
  border:1px solid var(--card-br); border-radius:18px;
  box-shadow:0 18px 42px rgba(69,123,255,.08);
}
.card-glass .card-header{
  background: linear-gradient(180deg, #f3f7ff, #eaf1ff);
  color: var(--primary-blue-20);
  border-bottom:1px solid var(--primary-blue-70);
  border-radius:18px 18px 0 0;
}
.table.detail{
  margin:0; border-collapse: separate; border-spacing:0; font-size:.95rem;
}
.table.detail tbody th{
  width: 280px; white-space:nowrap; background:#f8fbff;
  border-bottom:1px solid var(--row-border); padding:.6rem .75rem; color:var(--primary-blue-20);
}
.table.detail tbody td{
  border-bottom:1px solid var(--row-border); padding:.6rem .75rem; color:var(--ink-700);
}
.table.detail tbody tr:last-child th,
.table.detail tbody tr:last-child td{ border-bottom:none; }

/* ===== Utilitarios ===== */
.sep-title{
  display:flex; align-items:center; gap:.5rem; color:var(--ink-500); font-weight:800; letter-spacing:.3px;
  margin:.2rem 0 .7rem 0;
}
.sep-title::after{
  content:""; flex:1; height:2px; border-radius:2px;
  background: linear-gradient(90deg, var(--primary-blue-70), transparent);
  opacity:.35;
}
.shadow-soft{ box-shadow:0 10px 26px rgba(69,123,255,.10); }
</style>

<!-- ===== HERO + ACCIONES ===== -->
<div class="hero">
  <div class="d-flex align-items-start gap-3 flex-wrap">
    <h3 class="title mb-2">
      Expediente {{ item.nro_expediente_cpim or ('#' ~ item.id) }}
    </h3>

    <div class="ms-auto actions-bar">
      <!-- Botones (se mantienen los endpoints y mÃ©todos) -->
      <form method="post" action="{{ url_for('generar_word_expediente', item_id=item.id) }}" class="d-inline">
        <button type="submit" class="btn-strong" title="Generar documento Word">ðŸ“„ Word</button>
      </form>

      <form method="post" action="{{ url_for('generar_visado_expediente', item_id=item.id) }}" class="d-inline">
        <button type="submit" class="btn-strong" title="Generar documento de Visado">ðŸ“‹ Visado</button>
      </form>

      <form method="post" action="{{ url_for('generar_adicional_expediente', item_id=item.id) }}" class="d-inline">
        <button type="submit" class="btn-strong" title="Generar documento Adicional">ðŸ“‘ Adicional</button>
      </form>

      <a class="btn-outline" href="{{ url_for('editar_expediente', item_id=item.id) }}">Editar</a>
    </div>
  </div>

  <!-- Chips de estado -->
  <div class="meta">
    {% if item.formato == 'Digital' %}
      <span class="badge-soft">ðŸ“± Digital</span>
    {% elif item.formato == 'Papel' %}
      <span class="badge-soft gray">ðŸ“„ Papel</span>
    {% endif %}

    {% if item.finalizado %}
      <span class="badge-soft success">âœ“ Finalizado</span>
    {% else %}
      <span class="badge-soft warn">En curso</span>
    {% endif %}

    {% if item.gop_numero %}
      <span class="badge-soft info">GOP: {{ item.gop_numero }}</span>
    {% endif %}

    {% if item.nro_expediente_cpim %}
      <span class="badge-soft">CPIM: {{ item.nro_expediente_cpim }}</span>
    {% endif %}
  </div>
</div>

<!-- ===== SOLO DIGITAL: mÃ©tricas + timeline ===== -->
{% if item.formato == 'Digital' %}
  {% set totales = item.get_dias_totales_por_bandeja() %}
  {% set historial = item.get_historial_bandejas() %}

  <div class="mb-3">
    <div class="sep-title">Resumen de bandejas</div>
    {% if totales and (totales.cpim > 0 or totales.imlauer > 0 or totales.onetto > 0 or totales.profesional > 0) %}
      <div class="metric-grid">
        <div class="metric info">
          <div class="body">
            <div class="value">{{ totales.cpim }}</div>
            <small>dÃ­as en CPIM</small>
          </div>
        </div>
        <div class="metric warn">
          <div class="body">
            <div class="value">{{ totales.imlauer }}</div>
            <small>dÃ­as en IMLAUER</small>
          </div>
        </div>
        <div class="metric gray">
          <div class="body">
            <div class="value">{{ totales.onetto }}</div>
            <small>dÃ­as en ONETTO</small>
          </div>
        </div>
        <div class="metric good">
          <div class="body">
            <div class="value">{{ totales.profesional }}</div>
            <small>dÃ­as en PROFESIONAL</small>
          </div>
        </div>
      </div>
      <div class="text-center mt-2">
        <span class="badge-soft" style="font-size:.95rem;">Total en sistema: {{ item.get_total_dias_en_sistema() }} dÃ­as</span>
      </div>
    {% else %}
      <div class="card card-glass">
        <div class="card-body text-center text-muted">
          <i class="bi bi-info-circle fs-3 d-block mb-2"></i>
          <div class="fw-bold">Historial en construcciÃ³n</div>
          <small>Se completa con las sincronizaciones GOP.</small>
        </div>
      </div>
    {% endif %}
  </div>

  {% if historial and historial|length > 0 %}
  <div class="mb-4">
    <div class="sep-title">LÃ­nea de tiempo</div>
    <div class="timeline-wrap">
      <div class="timeline">
        {% for registro in historial %}
        <div class="timeline-item">
          <!-- LÃ­nea vertical (solo si no es el Ãºltimo) -->
          {% if not loop.last %}<div class="vline"></div>{% endif %}

          <!-- Marker -->
          {% if registro.bandeja_tipo == 'cpim' %}
            <div class="marker info"><i class="bi bi-building"></i></div>
          {% elif registro.bandeja_tipo == 'imlauer' %}
            <div class="marker warn"><i class="bi bi-person-check"></i></div>
          {% elif registro.bandeja_tipo == 'onetto' %}
            <div class="marker gray"><i class="bi bi-clipboard-check"></i></div>
          {% else %}
            <div class="marker good"><i class="bi bi-person-workspace"></i></div>
          {% endif %}

          <!-- Tarjeta -->
          <div class="tcard shadow-soft">
            <div class="trow">
              <div>
                <strong class="text-uppercase" style="color:var(--primary-blue-20)">{{ registro.bandeja_tipo }}</strong><br>
                <small class="text-muted">{{ registro.bandeja_nombre or '-' }}</small>
              </div>
              <div>
                <small class="text-muted">Usuario</small><br>
                <span class="fw-semibold">{{ registro.usuario_asignado or '-' }}</span>
              </div>
              <div>
                <small class="text-muted">PerÃ­odo</small><br>
                <span class="fw-semibold">
                  {{ registro.fecha_inicio.strftime('%d/%m/%Y') }}
                  {% if registro.fecha_fin %}
                    â€“ {{ registro.fecha_fin.strftime('%d/%m/%Y') }}
                  {% else %}
                    â€“ <span class="text-success">Actual</span>
                  {% endif %}
                </span>
              </div>
              <div class="text-md-end">
                {% if registro.esta_activo %}
                  <span class="badge-soft success">{{ registro.dias_calculados }} dÃ­as</span><br>
                  <small class="text-success">Activo</small>
                {% else %}
                  <span class="badge-soft gray">{{ registro.dias_en_bandeja or registro.dias_calculados }} dÃ­as</span><br>
                  <small class="text-muted">Finalizado</small>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}
{% else %}
  <!-- Papel -->
  <div class="card card-glass mb-4">
    <div class="card-header">
      <h5 class="card-title mb-0"><i class="bi bi-file-earmark"></i> Expediente en Formato Papel</h5>
    </div>
    <div class="card-body text-center">
      <i class="bi bi-file-earmark-text fs-1 d-block mb-2" style="color:var(--primary-blue-20)"></i>
      <div class="fw-bold mb-1">TramitaciÃ³n FÃ­sica</div>
      <p class="text-muted mb-2">Este expediente se tramita en papel y no requiere seguimiento digital.</p>
      <span class="badge-soft gray">Los expedientes en papel no se procesan en GOP</span>
    </div>
  </div>
{% endif %}

<!-- ===== Detalles del expediente ===== -->
<div class="card card-glass">
  <div class="card-header">
    <h5 class="card-title mb-0">Detalles del Expediente</h5>
  </div>
  <div class="card-body">
    <table class="table detail">
      <tbody>
        <tr><th>Fecha</th><td>{{ item.fecha or '-' }}</td></tr>
        <tr><th>ProfesiÃ³n</th><td>{{ item.profesion or '-' }}</td></tr>
        <tr><th>Formato</th><td>
          {% if item.formato == 'Digital' %}
            <span class="badge-soft">ðŸ“± Digital</span>
          {% elif item.formato == 'Papel' %}
            <span class="badge-soft gray">ðŸ“„ Papel</span>
          {% else %} {{ item.formato or '-' }} {% endif %}
        </td></tr>
        <tr><th>NÂ° de copias</th><td>{{ item.nro_copias or '-' }}</td></tr>
        <tr><th>Tipo de trabajo</th><td>{{ item.tipo_trabajo or '-' }}</td></tr>
        <tr><th>NÂ° expediente CPIM</th><td>{{ item.nro_expediente_cpim or '-' }}</td></tr>

        <tr>
          <th>Profesional(es)</th>
          <td>
            {% set todos_profesionales = item.todos_los_profesionales %}
            {% if todos_profesionales %}
              {% for profesional in todos_profesionales %}
                <div class="mb-2">
                  {% if profesional.es_principal %}
                    <div class="d-flex align-items-center">
                      <span class="badge-soft info me-2">Principal</span>
                      <strong style="color:var(--primary-blue-20)">{{ profesional.nombre }}</strong>
                    </div>
                    <div class="ms-4">
                      <small class="text-muted">ProfesiÃ³n: {{ profesional.profesion or 'No especificada' }}</small>
                      {% if profesional.whatsapp %}
                        <br><small class="text-muted">ðŸ“± {{ profesional.whatsapp }}</small>
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="d-flex align-items-center mt-2 pt-2" style="border-top:1px dashed var(--card-br);">
                      <span class="badge-soft gray me-2">Adicional</span>
                      <strong class="text-dark">{{ profesional.nombre }}</strong>
                    </div>
                    <div class="ms-4">
                      <small class="text-muted">ProfesiÃ³n: {{ profesional.profesion or 'No especificada' }}</small>
                      {% if profesional.whatsapp %}
                        <br><small class="text-muted">ðŸ“± {{ profesional.whatsapp }}</small>
                      {% endif %}
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>
        </tr>

        <tr><th>Comitente</th><td>{{ item.nombre_comitente or '-' }}</td></tr>
        <tr><th>UbicaciÃ³n</th><td>{{ item.ubicacion or '-' }}</td></tr>
        <tr><th>Partida Inmobiliaria</th><td>{{ item.partida_inmobiliaria or '-' }}</td></tr>
        <tr><th>NÃºmero Expediente Municipal</th><td>{{ item.nro_expediente_municipal or '-' }}</td></tr>

        <tr><th>Estado pago sellado</th><td>{{ (item.estado_pago_sellado or 'pendiente')|capitalize }}</td></tr>
        <tr><th>Estado pago visado</th><td>{{ (item.estado_pago_visado or 'pendiente')|capitalize }}</td></tr>

        <tr><th>Tasa de sellado</th><td>{{ item.tasa_sellado_monto|ars }}</td></tr>
        <tr><th>Visado elÃ©ctrica</th><td>{{ item.tasa_visado_electrica_monto|ars }}</td></tr>
        <tr><th>Visado salubridad</th><td>{{ item.tasa_visado_salubridad_monto|ars }}</td></tr>
        <tr><th>Visado gas</th><td>{{ item.tasa_visado_gas_monto|ars }}</td></tr>
        <tr><th>Visado electromecÃ¡nica</th><td>{{ item.tasa_visado_electromecanica_monto|ars }}</td></tr>
        <tr><th>Total visados</th><td><strong>{{ item.total_visados|ars }}</strong></td></tr>

        <tr><th>Fecha de salida</th><td>{{ item.fecha_salida or '-' }}</td></tr>
        <tr><th>Persona que retira</th><td>{{ item.persona_retira or '-' }}</td></tr>
        <tr><th>NÂ° de caja</th><td>{{ item.nro_caja or '-' }}</td></tr>

        {% if item.formato == 'Digital' %}
          <tr><th>NÃºmero de GOP</th><td>
            {% if item.gop_numero %}
              <span class="badge-soft info">{{ item.gop_numero }}</span>
            {% else %}<span class="text-muted">No asignado</span>{% endif %}
          </td></tr>
          <tr>
            <th>Archivos PDF</th>
            <td>
              {% if item.archivos and item.archivos|length %}
                <ul class="mb-0">
                  {% for a in item.archivos %}
                    <li>
                      {% set name = a.filename or 'archivo.pdf' %}
                      {% if a.public_url %}
                        <a href="{{ a.public_url }}" target="_blank" rel="noopener">{{ name }}</a>
                      {% else %}
                        {% set parts = a.gcs_path.split('gs://')[-1].split('/', 1) %}
                        {% set bucket = parts[0] %}
                        {% set key = parts[1] if parts|length > 1 else '' %}
                        <a href="https://storage.googleapis.com/{{ bucket }}/{{ key }}" target="_blank" rel="noopener">{{ name }}</a>
                        <small class="text-muted">(puede requerir permisos pÃºblicos del bucket)</small>
                      {% endif %}
                      {% if a.size_bytes %}
                        <small class="text-muted">â€” {{ (a.size_bytes / 1024)|round(1) }} KB</small>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <span class="text-muted">Sin archivos adjuntos</span>
              {% endif %}
            </td>
          </tr>
        {% else %}
          <tr><th>NÃºmero de GOP</th><td><span class="text-muted">No aplica (formato papel)</span></td></tr>
          <tr><th>Archivos PDF</th><td><span class="text-muted">No aplica (formato papel)</span></td></tr>
        {% endif %}

        <tr><th>WhatsApp Tramitador</th><td>{{ item.whatsapp_tramitador or '-' }}</td></tr>
        <tr><th>Creado</th><td>{{ item.created_at }}</td></tr>
        <tr><th>Actualizado</th><td>{{ item.updated_at }}</td></tr>
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
