{% extends 'base.html' %}
{% block title %}Cambiar Contrase√±a ‚Äî CPIM{% endblock %}
{% block content %}

<style>
:root {
  --primary-blue-90: hsl(220,100%,90%);
  --primary-blue-80: hsl(220,100%,80%);
  --primary-blue-70: hsl(220,100%,70%);
  --primary-blue-60: hsl(220,100%,60%);
  --primary-blue-55: hsl(220,100%,55%);
  --primary-blue-50: hsl(220,100%,50%);
  --primary-blue-40: hsl(220,100%,40%);
  --primary-blue-30: hsl(220,100%,30%);
  --primary-blue-20: hsl(220,100%,20%);
  --card-br: rgba(69,123,255,.18);
}

.password-container {
  max-width: 600px;
  margin: 0 auto;
}

.password-card {
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid var(--card-br);
  border-radius: 20px;
  padding: 3rem;
  margin-bottom: 2rem;
  box-shadow: 0 20px 40px rgba(69, 123, 255, 0.1);
  position: relative;
  overflow: hidden;
}

.password-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 5px;
  background: linear-gradient(90deg, var(--primary-blue-50), var(--primary-blue-30));
}

.password-header {
  text-align: center;
  margin-bottom: 2.5rem;
}

.password-icon {
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, var(--primary-blue-55), var(--primary-blue-40));
  border-radius: 20px;
  margin: 0 auto 1.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.5rem;
  color: white;
  box-shadow: 0 15px 35px rgba(69, 123, 255, 0.3);
}

.password-title {
  color: var(--primary-blue-20);
  font-weight: 800;
  font-size: 1.8rem;
  margin-bottom: 0.5rem;
}

.password-subtitle {
  color: var(--primary-blue-40);
  opacity: 0.8;
}

.form-floating {
  margin-bottom: 1.5rem;
}

.form-floating > .form-control {
  border: 2px solid var(--primary-blue-80);
  border-radius: 12px;
  padding: 1rem;
  background: rgba(255, 255, 255, 0.9);
  transition: all 0.3s ease;
}

.form-floating > .form-control:focus {
  border-color: var(--primary-blue-50);
  box-shadow: 0 0 0 0.2rem rgba(69, 123, 255, 0.15);
  background: white;
}

.form-floating > label {
  color: var(--primary-blue-20);
  font-weight: 600;
  opacity: 0.8;
}

.btn-change-password {
  background: linear-gradient(135deg, var(--primary-blue-55), var(--primary-blue-40));
  border: none;
  color: white;
  padding: 0.75rem 1.5rem;
  border-radius: 12px;
  font-weight: 700;
  font-size: 1.05rem;
  width: 100%;
  transition: all 0.3s ease;
  box-shadow: 0 10px 25px rgba(69, 123, 255, 0.25);
  margin-bottom: 1.5rem;
}

.btn-change-password:hover {
  transform: translateY(-2px);
  box-shadow: 0 15px 35px rgba(69, 123, 255, 0.35);
  filter: brightness(1.05);
  color: white;
}

.btn-back {
  border: 2px solid var(--primary-blue-55);
  color: var(--primary-blue-20);
  background: white;
  padding: 0.75rem 1.5rem;
  border-radius: 12px;
  font-weight: 700;
  text-decoration: none;
  display: inline-block;
  width: 100%;
  text-align: center;
  transition: all 0.3s ease;
}

.btn-back:hover {
  background: var(--primary-blue-90);
  color: var(--primary-blue-20);
  text-decoration: none;
  transform: translateY(-1px);
}

.security-tips {
  background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
  border: 1px solid #7dd3fc;
  border-radius: 12px;
  padding: 1.5rem;
  margin-top: 2rem;
}

.security-tips h5 {
  color: #0369a1;
  font-weight: 700;
  margin-bottom: 1rem;
}

.security-tips ul {
  color: #0c4a6e;
  margin-bottom: 0;
}

.security-tips li {
  margin-bottom: 0.5rem;
}

.password-strength {
  margin-top: 0.5rem;
  font-size: 0.9rem;
}

.strength-weak { color: #dc2626; }
.strength-medium { color: #f59e0b; }
.strength-strong { color: #16a34a; }

.alert {
  border: none;
  border-radius: 12px;
  margin-bottom: 1.5rem;
  font-weight: 600;
}

.alert-danger {
  background: linear-gradient(135deg, #fef2f2, #fee2e2);
  color: #dc2626;
  border-left: 4px solid #dc2626;
}

.alert-success {
  background: linear-gradient(135deg, #f0fff4, #dcfce7);
  color: #16a34a;
  border-left: 4px solid #16a34a;
}

@media (max-width: 768px) {
  .password-card {
    padding: 2rem 1.5rem;
  }
  
  .password-title {
    font-size: 1.5rem;
  }
}
</style>

<div class="password-container">
  <div class="password-card">
    <!-- Header -->
    <div class="password-header">
      <div class="password-icon">
        üîí
      </div>
      <h1 class="password-title">Cambiar Contrase√±a</h1>
      <p class="password-subtitle">Actualiza tu contrase√±a de acceso</p>
    </div>

    <!-- Mensajes Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Formulario -->
    <form method="POST" novalidate>
      <div class="form-floating">
        <input type="password" class="form-control" id="password_actual" name="password_actual" 
               placeholder="Contrase√±a actual" required>
        <label for="password_actual">üîê Contrase√±a Actual</label>
      </div>

      <div class="form-floating">
        <input type="password" class="form-control" id="password_nueva" name="password_nueva" 
               placeholder="Nueva contrase√±a" required>
        <label for="password_nueva">üÜï Nueva Contrase√±a</label>
        <div id="passwordStrength" class="password-strength"></div>
      </div>

      <div class="form-floating">
        <input type="password" class="form-control" id="password_confirmar" name="password_confirmar" 
               placeholder="Confirmar nueva contrase√±a" required>
        <label for="password_confirmar">‚úÖ Confirmar Nueva Contrase√±a</label>
      </div>

      <button type="submit" class="btn btn-change-password">
        üîÑ Cambiar Contrase√±a
      </button>

      <a href="{{ url_for('perfil') }}" class="btn-back">
        ‚Üê Volver al Perfil
      </a>
    </form>

    <!-- Consejos de seguridad -->
    <div class="security-tips">
      <h5>üí° Consejos para una contrase√±a segura:</h5>
      <ul>
        <li><strong>Al menos 8 caracteres</strong> de longitud</li>
        <li>Combina <strong>letras may√∫sculas y min√∫sculas</strong></li>
        <li>Incluye <strong>n√∫meros y s√≠mbolos</strong></li>
        <li><strong>No uses informaci√≥n personal</strong> (nombres, fechas)</li>
        <li><strong>No reutilices</strong> contrase√±as de otras cuentas</li>
      </ul>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const passwordField = document.getElementById('password_nueva');
  const confirmField = document.getElementById('password_confirmar');
  const strengthDiv = document.getElementById('passwordStrength');

  function checkPasswordStrength(password) {
    let strength = 0;
    let feedback = [];

    if (password.length >= 8) strength++;
    else feedback.push('Al menos 8 caracteres');

    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
    else feedback.push('May√∫sculas y min√∫sculas');

    if (/\d/.test(password)) strength++;
    else feedback.push('Al menos un n√∫mero');

    if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength++;
    else feedback.push('Al menos un s√≠mbolo');

    let strengthText = '';
    let strengthClass = '';

    if (strength <= 1) {
      strengthText = 'üî¥ D√©bil';
      strengthClass = 'strength-weak';
    } else if (strength <= 2) {
      strengthText = 'üü° Media';
      strengthClass = 'strength-medium';
    } else if (strength <= 3) {
      strengthText = 'üü¢ Buena';
      strengthClass = 'strength-strong';
    } else {
      strengthText = 'üü¢ Excelente';
      strengthClass = 'strength-strong';
    }

    if (feedback.length > 0 && password.length > 0) {
      strengthText += ' (Falta: ' + feedback.join(', ') + ')';
    }

    return { text: strengthText, className: strengthClass };
  }

  function checkPasswordMatch() {
    if (confirmField.value && passwordField.value !== confirmField.value) {
      confirmField.setCustomValidity('Las contrase√±as no coinciden');
      confirmField.classList.add('is-invalid');
    } else {
      confirmField.setCustomValidity('');
      confirmField.classList.remove('is-invalid');
    }
  }

  passwordField.addEventListener('input', function() {
    const strength = checkPasswordStrength(this.value);
    strengthDiv.textContent = strength.text;
    strengthDiv.className = 'password-strength ' + strength.className;
    checkPasswordMatch();
  });

  confirmField.addEventListener('input', checkPasswordMatch);
});
</script>

{% endblock %}