{% extends 'base.html' %}
{% block title %}An√°lisis de Tasas de Visado ‚Äî CPIM{% endblock %}
{% block content %}

<div class="d-flex align-items-center mb-3">
  <h3 class="me-auto">An√°lisis de Tasas de Visado</h3>
  <a href="{{ url_for('lista_expedientes') }}" class="btn btn-secondary">‚Üê Volver</a>
</div>

<!-- Formulario de An√°lisis -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="card-title mb-0">Ejecutar Nuevo An√°lisis</h5>
  </div>
  <div class="card-body">
    <form method="post" action="{{ url_for('ejecutar_analisis_tasas') }}" class="row g-3">
      <div class="col-md-4">
        <label for="fecha_desde" class="form-label">Fecha Desde</label>
        <input type="date" class="form-control" id="fecha_desde" name="fecha_desde" 
               value="{{ fecha_desde or '' }}" required>
      </div>
      
      <div class="col-md-4">
        <label for="fecha_hasta" class="form-label">Fecha Hasta</label>
        <input type="date" class="form-control" id="fecha_hasta" name="fecha_hasta" 
               value="{{ fecha_hasta or '' }}" required>
      </div>
      
      <div class="col-md-4">
        <div class="form-check mt-4">
          <input class="form-check-input" type="checkbox" id="incluir_no_pagados" 
                 name="incluir_no_pagados" {{ 'checked' if incluir_no_pagados else '' }}>
          <label class="form-check-label" for="incluir_no_pagados">
            Incluir expedientes no pagados
          </label>
        </div>
      </div>
      
      <div class="col-12">
        <button type="submit" class="btn btn-primary">
          üìä Ejecutar An√°lisis
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Resultados del An√°lisis -->
{% if resultado %}
<div class="alert alert-info">
  <strong>An√°lisis ejecutado:</strong> 
  Per√≠odo del {{ resultado.fecha_desde.strftime('%d/%m/%Y') }} al {{ resultado.fecha_hasta.strftime('%d/%m/%Y') }}
</div>

<!-- Resumen Ejecutivo -->
<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <h5 class="card-title mb-0">üìà Resumen Ejecutivo</h5>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-3">
        <div class="card text-center border-success">
          <div class="card-body">
            <h4 class="text-success">{{ resultado.resumen.cantidad_expedientes_pagados }}</h4>
            <small>Expedientes Pagados</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center border-warning">
          <div class="card-body">
            <h4 class="text-warning">{{ resultado.resumen.cantidad_expedientes_no_pagados }}</h4>
            <small>Expedientes No Pagados</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center border-info">
          <div class="card-body">
            <h4 class="text-info">{{ resultado.resumen.total_general|ars }}</h4>
            <small>Total de Tasas</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center border-primary">
          <div class="card-body">
            <h4 class="text-primary">{{ resultado.resumen.honorarios_cpim|ars }}</h4>
            <small>Para CPIM (30%)</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- C√°lculo de Honorarios -->
<div class="card mb-4">
  <div class="card-header bg-success text-white">
    <h5 class="card-title mb-0">üí∞ C√°lculo de Honorarios por Ingeniero</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-bordered table-hover">
        <thead class="table-dark">
          <tr>
            <th>Ingeniero</th>
            <th>Total Tasas</th>
            <th>Para Consejo (30%)</th>
            <th>Para Ingeniero (70%)</th>
            <th>Tipos de Visado</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>IMLAUER FERNANDO</strong></td>
            <td>{{ resultado.honorarios.imlauer.total_tasas|ars }}</td>
            <td>{{ resultado.honorarios.imlauer.para_cpim|ars }}</td>
            <td class="table-success"><strong>{{ resultado.honorarios.imlauer.para_ingeniero|ars }}</strong></td>
            <td>Gas, Salubridad</td>
          </tr>
          <tr>
            <td><strong>ONETTO JOS√â</strong></td>
            <td>{{ resultado.honorarios.onetto.total_tasas|ars }}</td>
            <td>{{ resultado.honorarios.onetto.para_cpim|ars }}</td>
            <td class="table-success"><strong>{{ resultado.honorarios.onetto.para_ingeniero|ars }}</strong></td>
            <td>El√©ctrica, Electromec√°nica</td>
          </tr>
        </tbody>
        <tfoot class="table-secondary">
          <tr>
            <th>TOTALES</th>
            <th>{{ resultado.honorarios.totales_generales.total_todas_tasas|ars }}</th>
            <th>{{ resultado.honorarios.totales_generales.total_para_cpim|ars }}</th>
            <th>{{ resultado.honorarios.totales_generales.total_para_ingenieros|ars }}</th>
            <th>-</th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<!-- Totales por Tipo de Visado -->
<div class="card mb-4">
  <div class="card-header bg-info text-white">
    <h5 class="card-title mb-0">üìã Totales por Tipo de Visado (Solo obras pagadas)</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Tipo de Visado</th>
            <th>Total Pagado</th>
            <th>Ingeniero Responsable</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Gas</td>
            <td>{{ resultado.totales_por_tipo.gas|ars }}</td>
            <td>IMLAUER FERNANDO</td>
          </tr>
          <tr>
            <td>Salubridad</td>
            <td>{{ resultado.totales_por_tipo.salubridad|ars }}</td>
            <td>IMLAUER FERNANDO</td>
          </tr>
          <tr>
            <td>El√©ctrica</td>
            <td>{{ resultado.totales_por_tipo.electrica|ars }}</td>
            <td>ONETTO JOS√â</td>
          </tr>
          <tr>
            <td>Electromec√°nica</td>
            <td>{{ resultado.totales_por_tipo.electromecanica|ars }}</td>
            <td>ONETTO JOS√â</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

<!-- Expedientes No Pagados -->
{% if resultado.expedientes_no_pagados %}
<div class="card mb-4">
  <div class="card-header bg-warning text-dark">
    <h5 class="card-title mb-0">‚è≥ Obras No Pagadas ({{ resultado.expedientes_no_pagados|length }})</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm table-hover">
        <thead class="table-warning">
          <tr>
            <th>Fecha</th>
            <th>Profesional</th>
            <th>Comitente</th>
            <th>Gas</th>
            <th>Salubridad</th>
            <th>El√©ctrica</th>
            <th>Electromec√°nica</th>
            <th>Total Visados</th>
            <th>N¬∞ CPIM</th>
            <th>GOP</th>
          </tr>
        </thead>
        <tbody>
          {% for exp in resultado.expedientes_no_pagados %}
          <tr>
            <td>{{ exp.fecha.strftime('%d/%m/%Y') if exp.fecha else '-' }}</td>
            <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">{{ exp.profesional or '-' }}</td>
            <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">{{ exp.comitente or '-' }}</td>
            <td>{{ exp.gas|ars if exp.gas > 0 else '-' }}</td>
            <td>{{ exp.salubridad|ars if exp.salubridad > 0 else '-' }}</td>
            <td>{{ exp.electrica|ars if exp.electrica > 0 else '-' }}</td>
            <td>{{ exp.electromecanica|ars if exp.electromecanica > 0 else '-' }}</td>
            <td><strong>{{ exp.total_visados|ars }}</strong></td>
            <td>{{ exp.nro_expediente_cpim or '-' }}</td>
            <td>{{ exp.gop_numero or '-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

<!-- Acciones del An√°lisis -->
{% if resultado.expedientes_pagados %}
<div class="card mb-4 border-warning">
  <div class="card-header bg-warning text-dark">
    <h5 class="card-title mb-0">‚ö†Ô∏è Confirmar Cierre de Pago</h5>
  </div>
  <div class="card-body">
    <div class="alert alert-warning">
      <strong>¬°Atenci√≥n!</strong> Una vez confirmado el cierre, los <strong>{{ resultado.expedientes_pagados|length }} expedientes pagados</strong> 
      ser√°n marcados como procesados y no aparecer√°n en an√°lisis futuros.
    </div>
    
    <form method="post" action="{{ url_for('cerrar_analisis_tasas') }}" 
          onsubmit="return confirm('¬øEst√° seguro de que desea cerrar este an√°lisis? Esta acci√≥n no se puede deshacer.')">
      <div class="row g-3">
        <div class="col-md-6">
          <label for="nombre_cierre" class="form-label">Nombre del Cierre *</label>
          <input type="text" class="form-control" id="nombre_cierre" name="nombre_cierre" 
                 placeholder="Ej: Honorarios Julio 2025" required>
        </div>
        
        <div class="col-md-6">
          <label for="observaciones" class="form-label">Observaciones</label>
          <input type="text" class="form-control" id="observaciones" name="observaciones" 
                 placeholder="Observaciones adicionales (opcional)">
        </div>
        
        <div class="col-12">
          <button type="submit" class="btn btn-success">
            ‚úÖ Confirmar Cierre y Procesar Pago
          </button>
          <small class="text-muted ms-3">
            Esto marcar√° {{ resultado.expedientes_pagados|length }} expedientes como procesados
          </small>
        </div>
      </div>
    </form>
  </div>
</div>
{% endif %}

{% endif %}

<!-- Cierres Anteriores -->
{% if cierres_anteriores %}
<div class="card">
  <div class="card-header">
    <h5 class="card-title mb-0">üìö Cierres Anteriores</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Per√≠odo</th>
            <th>Fecha Cierre</th>
            <th>Honorarios Imlauer</th>
            <th>Honorarios Onetto</th>
            <th>Para CPIM</th>
            <th>Total</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for cierre in cierres_anteriores %}
          <tr>
            <td><strong>{{ cierre.nombre_cierre }}</strong></td>
            <td>{{ cierre.fecha_desde.strftime('%d/%m/%Y') }} - {{ cierre.fecha_hasta.strftime('%d/%m/%Y') }}</td>
            <td>{{ cierre.fecha_cierre.strftime('%d/%m/%Y %H:%M') }}</td>
            <td>{{ cierre.total_imlauer|ars }}</td>
            <td>{{ cierre.total_onetto|ars }}</td>
            <td>{{ cierre.total_cpim|ars }}</td>
            <td><strong>{{ cierre.total_general|ars }}</strong></td>
            <td>
              <a href="{{ url_for('ver_cierre_tasas', cierre_id=cierre.id) }}" class="btn btn-sm btn-outline-primary">
                Ver Detalle
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}
    </div>
  </div>
</div>

<!-- Expedientes Pagados -->
{% if resultado.expedientes_pagados %}
<div class="card mb-4">
  <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">‚úÖ Obras Pagadas ({{ resultado.expedientes_pagados|length }})</h5>
    <div>
      <a href="{{ url_for('exportar_analisis_tasas', formato='excel') }}" class="btn btn-light btn-sm">
        üìÑ Exportar Excel
      </a>
      <a href="{{ url_for('exportar_analisis_tasas', formato='pdf') }}" class="btn btn-light btn-sm">
        üìÑ Exportar PDF
      </a>
    </div>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm table-hover">
        <thead class="table-dark">
          <tr>
            <th>Fecha</th>
            <th>Profesional</th>
            <th>Comitente</th>
            <th>Gas</th>
            <th>Salubridad</th>
            <th>El√©ctrica</th>
            <th>Electromec√°nica</th>
            <th>Total Visados</th>
            <th>N¬∞ CPIM</th>
            <th>GOP</th>
          </tr>
        </thead>
        <tbody>
          {% for exp in resultado.expedientes_pagados %}
          <tr>
            <td>{{ exp.fecha.strftime('%d/%m/%Y') if exp.fecha else '-' }}</td>
            <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">{{ exp.profesional or '-' }}</td>
            <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">{{ exp.comitente or '-' }}</td>
            <td>{{ exp.gas|ars if exp.gas > 0 else '-' }}</td>
            <td>{{ exp.salubridad|ars if exp.salubridad > 0 else '-' }}</td>
            <td>{{ exp.electrica|ars if exp.electrica > 0 else '-' }}</td>
            <td>{{ exp.electromecanica|ars if exp.electromecanica > 0 else '-' }}</td>
            <td><strong>{{ exp.total_visados|ars }}</strong></td>
            <td>{{ exp.nro_expediente_cpim or '-' }}</td>
            <td>{{ exp.gop_numero or '-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>