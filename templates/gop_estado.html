{% extends 'base.html' %}
{% block title %}Estado GOP ‚Äî CPIM{% endblock %}
{% block content %}

<style>
:root{
  --primary-blue-90: hsl(220,100%,90%);
  --primary-blue-80: hsl(220,100%,80%);
  --primary-blue-70: hsl(220,100%,70%);
  --primary-blue-55: hsl(220,100%,55%);
  --primary-blue-50: hsl(220,100%,50%);
  --primary-blue-40: hsl(220,100%,40%);
  --primary-blue-20: hsl(220,100%,20%);
  --ink-700:#22314d; --ink-500:#475569; --ink-300:#9aa3b2;
  --card-br: rgba(69,123,255,.18);
  --row-border: rgba(25, 60, 180, .22);
}

/* Header */
.header-wrap{ display:flex; align-items:center; gap:.75rem; margin-bottom:1rem; flex-wrap:wrap; }
.header-title{ color:var(--primary-blue-20); font-weight:900; margin:0; }
.btn-go-back{
  border:2px solid var(--primary-blue-55); color:var(--primary-blue-20); background:#fff;
  padding:.4rem .65rem; border-radius:12px; font-weight:800; font-size:.9rem;
}
.btn-go-back:hover{ background:var(--primary-blue-90); }

/* Cards */
.card-lux{
  background: rgba(255,255,255,.95);
  border:1px solid var(--card-br); border-radius:18px;
  box-shadow:0 12px 28px rgba(69,123,255,.08);
}
.card-lux .card-header{
  background: linear-gradient(180deg,#f3f7ff,#eaf1ff);
  color:var(--primary-blue-20);
  border-bottom:1px solid var(--primary-blue-70);
  border-radius:18px 18px 0 0;
  font-weight:800;
}

/* Tabla de estad√≠sticas */
.table.stats th{ color:var(--ink-700); font-weight:700; }
.table.stats td{ font-weight:800; color:var(--primary-blue-20); }
.table.stats tr+tr td, .table.stats tr+tr th{
  border-top:1px solid var(--row-border);
}

/* Bot√≥n fuerte */
.btn-sync{
  background:linear-gradient(135deg,var(--primary-blue-55),var(--primary-blue-40));
  border:none; color:#fff; padding:.6rem 1rem; border-radius:12px;
  font-weight:800; font-size:.95rem; box-shadow:0 10px 22px rgba(69,123,255,.25);
}
.btn-sync:hover{ transform:translateY(-1px); color:#fff; filter:brightness(.97); }

/* Alert */
.alert-soft{
  border:1px solid var(--card-br);
  background:linear-gradient(180deg,#f7faff,#ffffff);
  color:var(--primary-blue-20);
  border-radius:12px;
}
</style>

<!-- Header -->
<div class="header-wrap">
  <h3 class="header-title">Estado de Sincronizaci√≥n GOP</h3>
  <a href="{{ url_for('lista_expedientes') }}" class="btn-go-back ms-auto">‚Üê Volver</a>
</div>

<div class="row">
  <!-- Estad√≠sticas -->
  <div class="col-md-6">
    <div class="card card-lux mb-3">
      <div class="card-header"><h5 class="card-title mb-0">üìä Estad√≠sticas</h5></div>
      <div class="card-body">
        <table class="table stats table-borderless mb-0">
          <tr>
            <th>Expedientes con n√∫mero GOP:</th>
            <td class="text-end">{{ stats.total_con_gop }}</td>
          </tr>
          <tr>
            <th>Expedientes sincronizados:</th>
            <td class="text-end">
              {% if stats.total_sincronizados > 0 %}
                <span class="badge bg-success fs-6">{{ stats.total_sincronizados }}</span>
              {% else %}
                <span class="badge bg-warning text-dark fs-6">{{ stats.total_sincronizados }}</span>
              {% endif %}
            </td>
          </tr>
          <tr>
            <th>√öltima sincronizaci√≥n:</th>
            <td class="text-end">
              {% if stats.ultima_sincronizacion %}
                {{ stats.ultima_sincronizacion.strftime('%d/%m/%Y %H:%M:%S') }}
              {% else %}
                <span class="text-muted">Nunca</span>
              {% endif %}
            </td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <!-- Acciones -->
  <div class="col-md-6">
    <div class="card card-lux mb-3">
      <div class="card-header"><h5 class="card-title mb-0">‚öôÔ∏è Acciones</h5></div>
      <div class="card-body">
        <form method="post" action="{{ url_for('sincronizar_gop') }}">
          <button type="submit" class="btn-sync mb-3 w-100" 
                  onclick="return confirm('¬øEjecutar sincronizaci√≥n con GOP? Esto puede tomar unos minutos.')">
            üîÑ Ejecutar Sincronizaci√≥n
          </button>
        </form>
        <div class="alert-soft mb-0">
          <small>
            <strong>‚ÑπÔ∏è Nota:</strong> La sincronizaci√≥n descarga los datos del sistema GOP de Posadas 
            y actualiza los expedientes que tienen n√∫mero GOP asignado.
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

<button id="btn-sync">Sincronizar GOP</button>

<div id="gop-status" style="margin-top:1rem; display:none;">
  <div><strong>Estado:</strong> <span id="gop-status-text">-</span></div>
  <div id="gop-progress-wrap" style="width:100%; background:#eee; height:10px; margin-top:6px;">
    <div id="gop-progress-bar" style="width:0%; height:10px; background:#2d6cdf;"></div>
  </div>
  <div style="margin-top:6px;">
    <span id="gop-counts"></span>
  </div>
</div>

<script>
(async function(){
  const btn = document.getElementById('btn-sync');
  const box = document.getElementById('gop-status');
  const txt = document.getElementById('gop-status-text');
  const bar = document.getElementById('gop-progress-bar');
  const counts = document.getElementById('gop-counts');

  function render(state){
    box.style.display = 'block';
    txt.textContent = state.message ? `${state.status} ‚Äî ${state.message}` : state.status;
    const total = state.total || 0;
    const curr = state.progress || 0;
    const pct = total > 0 ? Math.round((curr/total)*100) : (state.status === 'done' ? 100 : 0);
    bar.style.width = pct + '%';
    counts.textContent = `Progreso: ${curr}/${total || '¬ø?'} ‚Äî OK: ${state.ok||0} ‚Äî Fallos: ${state.fail||0}`;
  }

  async function poll(taskId){
    while(true){
      const r = await fetch(`/gop/sync/status/${taskId}`);
      const s = await r.json();
      render(s);
      if (s.status === 'done' || s.status === 'error') break;
      await new Promise(res => setTimeout(res, 2500));
    }
  }

  btn?.addEventListener('click', async () => {
    btn.disabled = true;
    try{
      const r = await fetch('/gop/sync', {method: 'POST'});
      if(!r.ok){ throw new Error('No se pudo iniciar la sincronizaci√≥n'); }
      const {task_id} = await r.json();
      await poll(task_id);
    }catch(e){
      alert(e.message || e);
    }finally{
      btn.disabled = false;
    }
  });
})();
</script>

<!-- Info del proceso -->
<div class="mt-4">
  <div class="card card-lux">
    <div class="card-header"><h5 class="card-title mb-0">üìñ Informaci√≥n del Proceso</h5></div>
    <div class="card-body">
      <h6 class="fw-bold text-primary">¬øC√≥mo funciona la sincronizaci√≥n?</h6>
      <ol class="mb-3">
        <li>Se conecta al sistema GOP de Posadas usando las credenciales configuradas</li>
        <li>Extrae la informaci√≥n de la tabla <em>‚ÄúMis Bandejas‚Äù</em></li>
        <li>Busca expedientes en el CPIM que tengan el mismo n√∫mero GOP</li>
        <li>Actualiza los campos: bandeja actual, usuario asignado, estado y fecha de entrada</li>
      </ol>
      
      <h6 class="fw-bold text-primary">Campos que se sincronizan:</h6>
      <ul>
        <li><strong>Bandeja Actual:</strong> En qu√© bandeja se encuentra el expediente en GOP</li>
        <li><strong>Usuario Asignado:</strong> Qui√©n tiene asignado el expediente</li>
        <li><strong>Estado:</strong> Estado actual del expediente en GOP</li>
        <li><strong>Fecha de Entrada:</strong> Cu√°ndo ingres√≥ el expediente al sistema GOP</li>
      </ul>
    </div>
  </div>
</div>

{% endblock %}
