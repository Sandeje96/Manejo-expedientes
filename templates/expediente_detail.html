{% extends 'base.html' %}
{% block title %}Expediente {{ item.nro_expediente_cpim or item.id }} — CPIM{% endblock %}
{% block content %}
<div class="d-flex align-items-center mb-3">
  <h3 class="me-auto">Expediente {{ item.nro_expediente_cpim or ('#' ~ item.id) }}</h3>
  <a class="btn btn-outline-primary" href="{{ url_for('editar_expediente', item_id=item.id) }}">Editar</a>
</div>

<table class="table table-bordered">
  <tbody>
    <tr><th style="width:260px">Fecha</th><td>{{ item.fecha or '-' }}</td></tr>
    <tr><th>Profesión</th><td>{{ item.profesion or '-' }}</td></tr>
    <tr><th>Formato</th><td>{{ item.formato or '-' }}</td></tr>
    <tr><th>N° de copias</th><td>{{ item.nro_copias or '-' }}</td></tr>
    <tr><th>Tipo de trabajo</th><td>{{ item.tipo_trabajo or '-' }}</td></tr>
    <tr><th>N° expediente CPIM</th><td>{{ item.nro_expediente_cpim or '-' }}</td></tr>
    <tr><th>Profesional</th><td>{{ item.nombre_profesional or '-' }}</td></tr>
    <tr><th>Comitente</th><td>{{ item.nombre_comitente or '-' }}</td></tr>
    <tr><th>Ubicación</th><td>{{ item.ubicacion or '-' }}</td></tr>
    <tr><th>Partida Inmobiliaria</th><td>{{ item.partida_inmobiliaria or '-' }}</td></tr>
    <tr><th>Número Expediente Municipal</th><td>{{ item.nro_expediente_municipal or '-' }}</td></tr>
    <tr>
      <th>Visados</th>
      <td>
        Gas: {{ 'Sí' if item.visado_gas else 'No' }} |
        Salubridad: {{ 'Sí' if item.visado_salubridad else 'No' }} |
        Eléctrica: {{ 'Sí' if item.visado_electrica else 'No' }} |
        Electromecánica: {{ 'Sí' if item.visado_electromecanica else 'No' }}
      </td>
    </tr>
    <tr><th>Estado pago sellado</th><td>{{ (item.estado_pago_sellado or 'pendiente')|capitalize }}</td></tr>
    <tr><th>Estado pago visado</th><td>{{ (item.estado_pago_visado or 'pendiente')|capitalize }}</td></tr>
    <tr><th>Tasa de sellado</th><td>{{ item.tasa_sellado_monto|ars }}</td></tr>
    <tr><th>Visado eléctrica</th><td>{{ item.tasa_visado_electrica_monto|ars }}</td></tr>
    <tr><th>Visado salubridad</th><td>{{ item.tasa_visado_salubridad_monto|ars }}</td></tr>
    <tr><th>Visado gas</th><td>{{ item.tasa_visado_gas_monto|ars }}</td></tr>
    <tr><th>Visado electromecánica</th><td>{{ item.tasa_visado_electromecanica_monto|ars }}</td></tr>
    <tr class="table-secondary"><th>Total visados</th><td>{{ item.total_visados|ars }}</td></tr>
    <tr><th>Fecha de salida</th><td>{{ item.fecha_salida or '-' }}</td></tr>
    <tr><th>Persona que retira</th><td>{{ item.persona_retira or '-' }}</td></tr>
    <tr><th>N° de caja</th><td>{{ item.nro_caja or '-' }}</td></tr>
    <tr><th>Ruta carpeta</th><td>{{ item.ruta_carpeta or '-' }}</td></tr>

    {% if item.formato == 'Digital' %}
    <tr><th>Número de GOP</th><td>{{ item.gop_numero or '-' }}</td></tr>
    <tr>
      <th>Archivos PDF</th>
      <td>
        {% if item.archivos and item.archivos|length %}
          <ul class="mb-0">
            {% for a in item.archivos %}
              <li>
                {% set name = a.filename or 'archivo.pdf' %}
                {% if a.public_url %}
                  <a href="{{ a.public_url }}" target="_blank" rel="noopener">{{ name }}</a>
                {% else %}
                  {# Bucket con UBLA: usamos URL pública basada en IAM #}
                  {% set parts = a.gcs_path.split('gs://')[-1].split('/', 1) %}
                  {% set bucket = parts[0] %}
                  {% set key = parts[1] if parts|length > 1 else '' %}
                  <a href="https://storage.googleapis.com/{{ bucket }}/{{ key }}" target="_blank" rel="noopener">{{ name }}</a>
                  <small class="text-muted">(puede requerir permisos públicos del bucket)</small>
                {% endif %}
                {% if a.size_bytes %}
                  <small class="text-muted">— {{ (a.size_bytes / 1024)|round(1) }} KB</small>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <span class="text-muted">Sin archivos adjuntos</span>
        {% endif %}
      </td>
    </tr>
    {% endif %}

    <tr><th>WhatsApp Profesional</th><td>{{ item.whatsapp_profesional or '-' }}</td></tr>
    <tr><th>WhatsApp Tramitador</th><td>{{ item.whatsapp_tramitador or '-' }}</td></tr>
    <tr><th>Creado</th><td>{{ item.created_at }}</td></tr>
    <tr><th>Actualizado</th><td>{{ item.updated_at }}</td></tr>
  </tbody>
</table>
{% endblock %}