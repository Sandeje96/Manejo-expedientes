{% extends 'base.html' %}
{% block title %}{{ 'Editar' if item else 'Nuevo' }} expediente ‚Äî CPIM{% endblock %}
{% block content %}

<style>
/* Paleta de colores personalizada basada en hsl(220,100%,X%) */
:root {
  --primary-blue-80: hsl(220,100%,80%);
  --primary-blue-70: hsl(220,100%,70%);
  --primary-blue-60: hsl(220,100%,60%);
  --primary-blue-50: hsl(220,100%,50%);
  --primary-blue-40: hsl(220,100%,40%);
  --primary-blue-30: hsl(220,100%,30%);
  --primary-blue-20: hsl(220,100%,20%);
  --primary-blue-10: hsl(220,100%,10%);
}

/* Contenedor principal con gradiente sutil */
.modern-form-container {
  background: linear-gradient(135deg, var(--primary-blue-80) 0%, #ffffff 100%);
  min-height: 100vh;
  padding: 2rem 0;
}

/* Tarjeta principal del formulario */
.form-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(69, 123, 255, 0.2);
  border-radius: 20px;
  box-shadow: 0 20px 40px rgba(69, 123, 255, 0.1);
  padding: 3rem;
  margin: 0 auto;
  max-width: 1200px;
}

/* T√≠tulo principal */
.form-title {
  color: var(--primary-blue-20);
  font-weight: 700;
  text-align: center;
  margin-bottom: 3rem;
  position: relative;
  font-size: 2.5rem;
}

.form-title::after {
  content: '';
  position: absolute;
  bottom: -10px;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 4px;
  background: linear-gradient(90deg, var(--primary-blue-50), var(--primary-blue-30));
  border-radius: 2px;
}

/* Secciones del formulario */
.form-section {
  background: linear-gradient(135deg, var(--primary-blue-80) 0%, rgba(255, 255, 255, 0.8) 100%);
  border: 1px solid var(--primary-blue-60);
  border-radius: 15px;
  padding: 2rem;
  margin-bottom: 2rem;
  position: relative;
  overflow: hidden;
}

.form-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary-blue-50), var(--primary-blue-30));
}

.section-title {
  color: var(--primary-blue-20);
  font-weight: 600;
  font-size: 1.5rem;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

.section-title::before {
  content: '';
  width: 6px;
  height: 6px;
  background: var(--primary-blue-50);
  border-radius: 50%;
}

/* Campos del formulario */
.form-label {
  color: var(--primary-blue-20);
  font-weight: 600;
  margin-bottom: 8px;
}

.form-control, .form-select {
  border: 2px solid var(--primary-blue-70);
  border-radius: 10px;
  padding: 12px 16px;
  transition: all 0.3s ease;
  background: rgba(255, 255, 255, 0.9);
}

.form-control:focus, .form-select:focus {
  border-color: var(--primary-blue-50);
  box-shadow: 0 0 0 0.2rem rgba(69, 123, 255, 0.25);
  background: white;
}

.form-control:hover, .form-select:hover {
  border-color: var(--primary-blue-60);
}

/* Texto de ayuda */
.form-text {
  color: var(--primary-blue-30);
  font-size: 0.9rem;
  margin-top: 5px;
}

/* Botones modernos */
.btn-modern-primary {
  background: linear-gradient(135deg, var(--primary-blue-50), var(--primary-blue-40));
  border: none;
  color: white;
  padding: 14px 30px;
  font-weight: 600;
  border-radius: 10px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(69, 123, 255, 0.3);
}

.btn-modern-primary:hover {
  background: linear-gradient(135deg, var(--primary-blue-40), var(--primary-blue-30));
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(69, 123, 255, 0.4);
  color: white;
}

.btn-modern-secondary {
  background: linear-gradient(135deg, var(--primary-blue-70), var(--primary-blue-60));
  border: none;
  color: var(--primary-blue-20);
  padding: 14px 30px;
  font-weight: 600;
  border-radius: 10px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(69, 123, 255, 0.2);
}

.btn-modern-secondary:hover {
  background: linear-gradient(135deg, var(--primary-blue-60), var(--primary-blue-50));
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(69, 123, 255, 0.3);
  color: white;
}

/* Bot√≥n de agregar profesional */
.btn-outline-success {
  background: linear-gradient(135deg, var(--primary-blue-60), var(--primary-blue-50));
  border: 2px solid var(--primary-blue-50);
  color: white;
  padding: 10px 20px;
  font-size: 0.9rem;
  font-weight: 600;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.btn-outline-success:hover {
  background: linear-gradient(135deg, var(--primary-blue-50), var(--primary-blue-40));
  border-color: var(--primary-blue-40);
  transform: translateY(-1px);
  color: white;
  box-shadow: 0 4px 15px rgba(69, 123, 255, 0.3);
}

/* Campos de profesionales adicionales */
.additional-professional {
  background: rgba(255, 255, 255, 0.7);
  border: 1px solid var(--primary-blue-60);
  border-radius: 10px;
  padding: 1rem;
  margin-bottom: 1rem;
  position: relative;
}

.remove-professional {
  background: linear-gradient(135deg, #ff6b6b, #ee5a52);
  border: none;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 0.8rem;
  position: absolute;
  top: 10px;
  right: 10px;
  transition: all 0.3s ease;
}

.remove-professional:hover {
  background: linear-gradient(135deg, #ee5a52, #dc3545);
  transform: scale(1.05);
}

/* Secci√≥n digital especial */
#digital-extra {
  background: linear-gradient(135deg, rgba(69, 123, 255, 0.1), rgba(255, 255, 255, 0.9));
  border: 2px dashed var(--primary-blue-60);
  border-radius: 15px;
  padding: 2rem;
  position: relative;
}

#digital-extra::before {
  content: 'üì±';
  position: absolute;
  top: -15px;
  left: 20px;
  background: white;
  padding: 0 10px;
  font-size: 1.5rem;
}

.digital-header {
  color: var(--primary-blue-20);
  font-weight: 600;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Autocompletado */
.autocomplete-input {
  position: relative;
}

.autocomplete-suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 2px solid var(--primary-blue-60);
  border-top: none;
  border-radius: 0 0 10px 10px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
  box-shadow: 0 8px 25px rgba(69, 123, 255, 0.2);
}

.autocomplete-suggestion {
  padding: 12px 16px;
  cursor: pointer;
  border-bottom: 1px solid var(--primary-blue-80);
  transition: background-color 0.2s ease;
}

.autocomplete-suggestion:hover {
  background: var(--primary-blue-80);
  color: var(--primary-blue-20);
}

.autocomplete-suggestion:last-child {
  border-bottom: none;
}

/* Separadores visuales */
.form-separator {
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--primary-blue-60), transparent);
  border: none;
  margin: 3rem 0;
}

/* Iconos de secci√≥n */
.section-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, var(--primary-blue-50), var(--primary-blue-40));
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.2rem;
  margin-right: 15px;
}

/* Responsividad */
@media (max-width: 768px) {
  .form-card {
    padding: 2rem 1rem;
    margin: 1rem;
    border-radius: 15px;
  }
  
  .form-title {
    font-size: 2rem;
  }
  
  .form-section {
    padding: 1.5rem;
  }
}
</style>

<div class="modern-form-container">
  <div class="form-card">
    <h3 class="form-title">{{ '‚úèÔ∏è Editar' if item else 'üìù Nuevo' }} Expediente</h3>

    <form method="post" enctype="multipart/form-data">
      <!-- SECCI√ìN: INFORMACI√ìN B√ÅSICA -->
      <div class="form-section">
        <h5 class="section-title">
          <div class="section-icon">üìÖ</div>
          Informaci√≥n B√°sica
        </h5>
        
        <div class="row g-3">
          <!-- Fecha -->
          <div class="col-md-3">
            <label class="form-label">üìÖ Fecha</label>
            <input
              type="date"
              name="fecha"
              class="form-control"
              value="{% if item and item.fecha %}{{ item.fecha.strftime('%Y-%m-%d') }}{% else %}{% endif %}">
          </div>

          <!-- Formato -->
          <div class="col-md-3">
            <label for="formato" class="form-label">üíæ Formato</label>
            <select id="formato" name="formato" class="form-select" required>
              {% set opciones = formatos if formatos else ['Papel','Digital'] %}
              {% for op in opciones %}
                {% if item %}
                  <option value="{{ op }}" {{ 'selected' if item.formato==op else '' }}>{{ op }}</option>
                {% else %}
                  <option value="{{ op }}" {{ 'selected' if loop.first else '' }}>{{ op }}</option>
                {% endif %}
              {% endfor %}
            </select>
            <div class="form-text">üì± Eleg√≠ "Digital" para habilitar carga de GOP y PDFs</div>
          </div>

          <!-- N¬∞ copias -->
          <div class="col-md-3">
            <label class="form-label">üìÑ N¬∞ de copias</label>
            <input type="number" name="nro_copias" class="form-control" min="0"
                   value="{{ (item.nro_copias if item else '') or '' }}">
          </div>

          <!-- Tipo de trabajo -->
          <div class="col-md-3">
            <label for="tipo_trabajo" class="form-label">üîß Tipo de trabajo</label>
            <select id="tipo_trabajo" name="tipo_trabajo" class="form-select" required>
              <option value="">Seleccionar tipo de trabajo</option>
              {% for tipo in tipos_trabajo %}
                {% if item %}
                  <option value="{{ tipo }}" {{ 'selected' if item.tipo_trabajo == tipo else '' }}>{{ tipo }}</option>
                {% else %}
                  <option value="{{ tipo }}">{{ tipo }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <!-- SECCI√ìN ESPECIAL PARA FORMATO DIGITAL -->
      <div id="digital-extra" class="col-12" style="display:none;">
        <h6 class="digital-header">
          üì± Datos para trabajos digitales
        </h6>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">üî¢ N√∫mero de GOP</label>
            <input type="text" name="gop_numero" class="form-control"
                   placeholder="GOP-XXXX-XXXX"
                   value="{{ (item.gop_numero if item else '') or '' }}">
          </div>

          <div class="col-md-6">
            <label class="form-label">üìÑ Archivos PDF</label>
            <input type="file" name="pdfs" class="form-control" accept="application/pdf" multiple>
            <div class="form-text">Pod√©s adjuntar uno o varios archivos .pdf</div>
          </div>
        </div>

        {% if item and item.archivos %}
          <div class="mt-3">
            <strong>üìé PDFs ya cargados:</strong>
            <ul class="mb-0">
              {% for a in item.archivos %}
                <li>
                  {% if a.public_url %}
                    <a href="{{ a.public_url }}" target="_blank" rel="noopener">{{ a.filename }}</a>
                  {% else %}
                    {{ a.filename }} <small class="text-muted">(no p√∫blico)</small>
                  {% endif %}
                  {% if a.size_bytes %}
                    <small class="text-muted">‚Äî {{ (a.size_bytes / 1024)|round(1) }} KB</small>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </div>

      <!-- SEPARADOR VISUAL -->
      <hr class="form-separator">

      <!-- SECCI√ìN: PROFESIONALES -->
      <div class="form-section">
        <h5 class="section-title">
          <div class="section-icon">üë•</div>
          Profesionales
        </h5>
        
        <div class="row g-3">
          <!-- Profesional Principal -->
          <div class="col-md-6">
            <label class="form-label">üë®‚Äçüíº Nombre del profesional principal</label>
            <div class="position-relative">
              <input 
                type="text" 
                name="nombre_profesional" 
                id="nombre_profesional"
                class="form-control autocomplete-input"
                autocomplete="off"
                placeholder="Escrib√≠ el nombre del profesional..."
                value="{{ (item.nombre_profesional if item else '') or '' }}"
                required>
              <div id="profesional_suggestions" class="autocomplete-suggestions"></div>
            </div>
          </div>

          <div class="col-md-6">
            <label for="profesion" class="form-label">üéì Profesi√≥n</label>
            <select id="profesion" name="profesion" class="form-select" required>
              {% for p in profesiones %}
                {% if item %}
                  <option value="{{ p }}" {{ 'selected' if item.profesion == p else '' }}>{{ p }}</option>
                {% else %}
                  <option value="{{ p }}" {{ 'selected' if loop.first else '' }}>{{ p }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>

          <!-- Profesionales Adicionales -->
          <div class="col-12">
            <label class="form-label">üë• Profesionales adicionales</label>
            <div id="profesionales-adicionales">
              {% if item and item.profesionales_adicionales %}
                {% for prof in item.profesionales_adicionales %}
                  <div class="additional-professional">
                    <button type="button" class="remove-professional" onclick="eliminarProfesional(this)">‚úï</button>
                    <div class="row g-2">
                      <div class="col-md-6">
                        <input type="text" name="profesionales_adicionales_nombre[]" class="form-control" 
                               placeholder="Nombre del profesional" value="{{ prof.nombre_profesional }}" autocomplete="off">
                      </div>
                      <div class="col-md-6">
                        <select name="profesionales_adicionales_profesion[]" class="form-select">
                          <option value="">Seleccionar profesi√≥n</option>
                          {% for p in profesiones %}
                            <option value="{{ p }}" {{ 'selected' if prof.profesion == p else '' }}>{{ p }}</option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% endif %}
            </div>
            
            <button type="button" class="btn btn-sm btn-outline-success" id="add-professional">
              ‚ûï Agregar Profesional
            </button>
          </div>
        </div>
      </div>

      <!-- SECCI√ìN: PROFESIONALES -->
      <div class="form-section">
        <h5 class="section-title">
          <div class="section-icon">üë•</div>
          Datos del Trabajo
        </h5>
        <div class="row g-3">
          <!-- Comitente -->
          <div class="col-md-6">
            <label class="form-label">üè¢ Nombre comitente</label>
            <div class="position-relative">
              <input 
                type="text" 
                name="nombre_comitente" 
                id="nombre_comitente"
                class="form-control autocomplete-input"
                autocomplete="off"
                placeholder="Escrib√≠ el nombre del comitente..."
                value="{{ (item.nombre_comitente if item else '') or '' }}">
              <div id="comitente_suggestions" class="autocomplete-suggestions"></div>
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">üìç Ubicaci√≥n</label>
            <input type="text" name="ubicacion" class="form-control" 
                   placeholder="Direcci√≥n completa..."
                   value="{{ (item.ubicacion if item else '') or '' }}">
          </div>

          <div class="col-md-6">
            <label class="form-label">üè† Partida Inmobiliaria</label>
            <input type="text" name="partida_inmobiliaria" class="form-control"
                   placeholder="N√∫mero de partida..."
                   value="{{ item.partida_inmobiliaria if item }}">
          </div>

          <div class="col-md-6">
            <label for="nro_expediente_municipal" class="form-label">üèõÔ∏è N√∫mero de Expediente Municipal</label>
            <input type="text" class="form-control" id="nro_expediente_municipal" name="nro_expediente_municipal"
                  placeholder="N√∫mero municipal..."
                  value="{{ item.nro_expediente_municipal or '' }}">
          </div>
        </div>
      </div>
      

      <!-- SEPARADOR VISUAL -->
      <hr class="form-separator">

      <!-- SECCI√ìN: DATOS ADMINISTRATIVOS -->
      <div class="form-section">
        <h5 class="section-title">
          <div class="section-icon">üìã</div>
          Datos Administrativos
        </h5>
        
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">üè¢ N¬∞ Expediente CPIM</label>
            <input type="text" name="nro_expediente_cpim" class="form-control"
                   placeholder="N√∫mero CPIM..."
                   value="{{ (item.nro_expediente_cpim if item else '') or '' }}">
          </div>

          <div class="col-md-4">
            <label class="form-label">üë§ Persona que retira</label>
            <input type="text" name="persona_retira" class="form-control"
                   placeholder="Nombre completo..."
                   value="{{ (item.persona_retira if item else '') or '' }}">
          </div>
          
          <div class="col-md-4">
            <label class="form-label">üì¶ N¬∞ de caja</label>
            <input type="number" name="nro_caja" class="form-control" min="0"
                   placeholder="N√∫mero de caja..."
                   value="{{ (item.nro_caja if item else '') or '' }}">
          </div>

          <div class="col-md-6">
            <label class="form-label">üìÖ Fecha de salida</label>
            <input
              type="date"
              name="fecha_salida"
              class="form-control"
              value="{% if item and item.fecha_salida %}{{ item.fecha_salida.strftime('%Y-%m-%d') }}{% else %}{% endif %}">
          </div>
        </div>
      </div>

      

      <!-- SEPARADOR VISUAL -->
      <hr class="form-separator">

      <!-- SECCI√ìN: TASAS -->
      <div class="form-section">
        <h5 class="section-title">
          <div class="section-icon">üí∞</div>
          Tasas y Pagos
        </h5>
        
        <div class="row g-3">
          <div class="col-md-12">
            <label class="form-label">üí∞ Tasa de sellado (ARS)</label>
            <input type="text" name="tasa_sellado_monto" class="form-control" inputmode="decimal"
                  placeholder="$ 0,00" value="{{ item.tasa_sellado_monto|ars if item and item.tasa_sellado_monto }}">
            <div class="form-text">Ingres√° el monto</div>
          </div>

          <div class="col-md-3">
            <label class="form-label">üí° Tasa visado el√©ctrica (ARS)</label>
            <input type="text" name="tasa_visado_electrica_monto" class="form-control" inputmode="decimal"
                  placeholder="$ 0,00" value="{{ item.tasa_visado_electrica_monto|ars if item and item.tasa_visado_electrica_monto }}">
          </div>

          <div class="col-md-3">
            <label class="form-label">üöø Tasa visado salubridad (ARS)</label>
            <input type="text" name="tasa_visado_salubridad_monto" class="form-control" inputmode="decimal"
                  placeholder="$ 0,00" value="{{ item.tasa_visado_salubridad_monto|ars if item and item.tasa_visado_salubridad_monto }}">
          </div>

          <div class="col-md-3">
            <label class="form-label">‚öôÔ∏è Tasa visado electrom. (ARS)</label>
            <input type="text" name="tasa_visado_electromecanica_monto" class="form-control" inputmode="decimal"
                  placeholder="$ 0,00" value="{{ item.tasa_visado_electromecanica_monto|ars if item and item.tasa_visado_electromecanica_monto }}">
          </div>

          <div class="col-md-3">
            <label class="form-label">üî• Tasa visado gas (ARS)</label>
            <input type="text" name="tasa_visado_gas_monto" class="form-control" inputmode="decimal"
                  placeholder="$ 0,00" value="{{ item.tasa_visado_gas_monto|ars if item and item.tasa_visado_gas_monto }}">
          </div>

          <div class="col-md-3">
            <label class="form-label">üìÑ Estado pago sellado</label>
            <select name="estado_pago_sellado" class="form-select" required>
              {% set opts = estados or ['pendiente','pagado','exento'] %}
              {% set val = (item.estado_pago_sellado if item and item.estado_pago_sellado else 'pendiente') %}
              {% for o in opts %}
                <option value="{{ o }}" {{ 'selected' if val==o else '' }}>{{ o|capitalize }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label">‚úÖ Estado pago visado</label>
            <select name="estado_pago_visado" class="form-select" required>
              {% set opts = estados or ['pendiente','pagado','exento'] %}
              {% set val = (item.estado_pago_visado if item and item.estado_pago_visado else 'pendiente') %}
              {% for o in opts %}
                <option value="{{ o }}" {{ 'selected' if val==o else '' }}>{{ o|capitalize }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <!-- BOTONES DE ACCI√ìN -->
      <div class="text-center mt-4">
        <button class="btn-modern-primary me-3" type="submit">
          üíæ Guardar Expediente
        </button>
        <a class="btn-modern-secondary" href="{{ url_for('lista_expedientes') }}">
          ‚ùå Cancelar
        </a>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // --- Toggle para secci√≥n Digital ---
  const formatoSelect = document.getElementById('formato');
  const digitalExtra = document.getElementById('digital-extra');

  function toggleDigitalExtra() {
    if (formatoSelect && digitalExtra) {
      digitalExtra.style.display = (formatoSelect.value === 'Digital') ? 'block' : 'none';
    }
  }
  toggleDigitalExtra();
  formatoSelect?.addEventListener('change', toggleDigitalExtra);

  // ========= NUEVO: FUNCIONALIDAD DE AUTOCOMPLETADO =========
  
  // Funci√≥n gen√©rica para configurar autocompletado
  function setupAutocomplete(inputId, suggestionsId, apiUrl) {
    const input = document.getElementById(inputId);
    const suggestionsDiv = document.getElementById(suggestionsId);
    
    if (!input || !suggestionsDiv) return;
    
    let timeoutId = null;
    
    // Funci√≥n para mostrar sugerencias
    function mostrarSugerencias(sugerencias) {
      suggestionsDiv.innerHTML = '';
      
      if (sugerencias.length === 0) {
        suggestionsDiv.style.display = 'none';
        return;
      }
      
      sugerencias.forEach(sugerencia => {
        const div = document.createElement('div');
        div.className = 'autocomplete-suggestion';
        div.textContent = sugerencia;
        
        // Al hacer click en una sugerencia
        div.addEventListener('click', function() {
          input.value = sugerencia;
          suggestionsDiv.style.display = 'none';
          suggestionsDiv.innerHTML = '';
        });
        
        suggestionsDiv.appendChild(div);
      });
      
      suggestionsDiv.style.display = 'block';
    }
    
    // Buscar sugerencias mientras escribe
    input.addEventListener('input', function() {
      const query = this.value.trim();
      
      // Limpiar timeout anterior
      if (timeoutId) {
        clearTimeout(timeoutId);
      }
      
      // Si hay menos de 2 caracteres, no buscar
      if (query.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
      }
      
      // Esperar 300ms antes de buscar (para no saturar con requests)
      timeoutId = setTimeout(async () => {
        try {
          const response = await fetch(`${apiUrl}?q=${encodeURIComponent(query)}`);
          if (response.ok) {
            const sugerencias = await response.json();
            mostrarSugerencias(sugerencias);
          }
        } catch (error) {
          console.error('Error buscando sugerencias:', error);
        }
      }, 300);
    });
    
    // Ocultar sugerencias al hacer click fuera
    document.addEventListener('click', function(e) {
      if (!input.contains(e.target) && !suggestionsDiv.contains(e.target)) {
        suggestionsDiv.style.display = 'none';
      }
    });
    
    // Navegaci√≥n con teclado
    input.addEventListener('keydown', function(e) {
      const suggestions = suggestionsDiv.querySelectorAll('.autocomplete-suggestion');
      let current = -1;
      
      // Encontrar elemento actualmente seleccionado
      suggestions.forEach((el, index) => {
        if (el.classList.contains('selected')) {
          current = index;
        }
      });
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        current = (current + 1) % suggestions.length;
        suggestions.forEach(el => el.classList.remove('selected'));
        if (suggestions[current]) {
          suggestions[current].classList.add('selected');
        }
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        current = current <= 0 ? suggestions.length - 1 : current - 1;
        suggestions.forEach(el => el.classList.remove('selected'));
        if (suggestions[current]) {
          suggestions[current].classList.add('selected');
        }
      } else if (e.key === 'Enter' && current >= 0) {
        e.preventDefault();
        if (suggestions[current]) {
          input.value = suggestions[current].textContent;
          suggestionsDiv.style.display = 'none';
        }
      } else if (e.key === 'Escape') {
        suggestionsDiv.style.display = 'none';
      }
    });
  }
  
  // Configurar autocompletado para profesional y comitente
  setupAutocomplete('nombre_profesional', 'profesional_suggestions', '/api/sugerencias-profesionales');
  setupAutocomplete('nombre_comitente', 'comitente_suggestions', '/api/sugerencias-comitentes');
  
  // ========= FIN DE FUNCIONALIDAD DE AUTOCOMPLETADO =========

  // --- Profesionales adicionales (c√≥digo existente) ---
  const addBtn = document.getElementById('add-professional');
  const container = document.getElementById('profesionales-adicionales');

  if (addBtn && container) {
    let profCount = container.querySelectorAll('.additional-professional').length;

    addBtn.addEventListener('click', function () {
      profCount++;
      const newProfHtml = `
        <div class="additional-professional mb-3 position-relative">
          <button type="button" class="btn btn-sm btn-danger remove-professional">Quitar</button>
          <div class="row g-3">
            <div class="col-md-6">
              <input type="text" name="profesionales_adicionales_nombre[]" class="form-control" 
                     placeholder="Nombre completo del profesional adicional...">
            </div>
            <div class="col-md-6">
              <select name="profesionales_adicionales_profesion[]" class="form-select">
                <option value="">Seleccionar profesi√≥n</option>
                {% for prof in profesiones %}
                  <option value="{{ prof }}">{{ prof }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', newProfHtml);
      attachRemoveHandlers();
    });

    function attachRemoveHandlers() {
      document.querySelectorAll('.remove-professional').forEach(btn => {
        btn.addEventListener('click', function () {
          this.closest('.additional-professional').remove();
        });
      });
    }
    attachRemoveHandlers();
  }

  // --- Formateo de montos con $ (c√≥digo existente) ---
  document.querySelectorAll('.money-input').forEach(function (input) {
    input.addEventListener('input', function () {
      let value = this.value.replace(/[^\d.,]/g, '');
      if (value && !value.startsWith('$')) {
        this.value = (value === '$' ? '$ ' : '') + value;
      }
    });

    input.addEventListener('blur', function () {
      let value = this.value.replace(/[^\d.,]/g, '');
      if (!value) {
        this.value = '';
        return;
      }
      if (!/,\d{1,2}$/.test(value)) {
        value = value.replace(/[.,]$/, '');
        value = value + ',00';
      }
      this.value = '$ ' + value;
    });
  });

  // --- Validaci√≥n visual del formulario (c√≥digo existente) ---
  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', function (e) {
      const requiredFields = this.querySelectorAll('[required]');
      let hasError = false;

      requiredFields.forEach(field => {
        if (!field.value || !field.value.trim()) {
          field.style.borderColor = '#ff6b6b';
          field.style.boxShadow = '0 0 0 0.2rem rgba(255, 107, 107, 0.25)';
          hasError = true;

          field.addEventListener('input', function onInput() {
            if (this.value.trim()) {
              this.style.borderColor = '';
              this.style.boxShadow = '';
              this.removeEventListener('input', onInput);
            }
          });
        }
      });

      if (hasError) {
        e.preventDefault();
        const firstError = this.querySelector('[required]:invalid, [style*="rgb(255, 107, 107)"]');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
          firstError.focus();
        }

        const errorMsg = document.createElement('div');
        errorMsg.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: linear-gradient(135deg, #ff6b6b, #ee5a52);
          color: white;
          padding: 15px 25px;
          border-radius: 10px;
          box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
          z-index: 10000;
          font-weight: 600;
          animation: slideInRight 0.3s ease;
        `;
        errorMsg.textContent = '‚ùå Por favor complet√° todos los campos obligatorios';
        document.body.appendChild(errorMsg);

        setTimeout(() => {
          errorMsg.style.animation = 'slideOutRight 0.3s ease';
          setTimeout(() => errorMsg.remove(), 300);
        }, 3000);
      }
    });
  }

  // Funci√≥n para agregar profesional adicional
  function agregarProfesional() {
    const container = document.getElementById('profesionales-adicionales');
    
    const newProfHtml = `
      <div class="additional-professional">
        <button type="button" class="remove-professional" onclick="eliminarProfesional(this)">‚úï</button>
        <div class="row g-2">
          <div class="col-md-6">
            <input type="text" name="profesionales_adicionales_nombre[]" class="form-control" 
                  placeholder="Nombre del profesional" autocomplete="off">
          </div>
          <div class="col-md-6">
            <select name="profesionales_adicionales_profesion[]" class="form-select">
              <option value="">Seleccionar profesi√≥n</option>
              {% for p in profesiones %}
                <option value="{{ p }}">{{ p }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
    `;
    
    container.insertAdjacentHTML('beforeend', newProfHtml);
  }

  // Funci√≥n para eliminar profesional
  function eliminarProfesional(button) {
    button.closest('.additional-professional').remove();
  }

  // --- Animaciones ---
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    .autocomplete-suggestion.selected {
      background: var(--primary-blue-80);
      color: var(--primary-blue-20);
    }
  `;
  document.head.appendChild(style);
});
</script>

{% endblock %}
