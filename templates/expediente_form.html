{% extends 'base.html' %}
{% block title %}{{ 'Editar' if item else 'Nuevo' }} expediente — CPIM{% endblock %}
{% block content %}
<h3 class="mb-3">{{ 'Editar' if item else 'Nuevo' }} expediente</h3>

<form method="post" enctype="multipart/form-data" class="row g-3">
  <!-- Fecha -->
  <div class="col-md-3">
    <label class="form-label">Fecha</label>
    <input
      type="date"
      name="fecha"
      class="form-control"
      value="{% if item and item.fecha %}{{ item.fecha.strftime('%Y-%m-%d') }}{% else %}{% endif %}">
  </div>

  <!-- Profesión (desplegable) -->
  <div class="col-md-3">
    <label for="profesion" class="form-label">Profesión</label>
    <select id="profesion" name="profesion" class="form-select" required>
      {% for p in profesiones %}
        {% if item %}
          <option value="{{ p }}" {{ 'selected' if item.profesion == p else '' }}>{{ p }}</option>
        {% else %}
          <option value="{{ p }}" {{ 'selected' if loop.first else '' }}>{{ p }}</option>
        {% endif %}
      {% endfor %}
    </select>
  </div>

  <!-- Formato -->
  <div class="col-md-3">
    <label for="formato" class="form-label">Formato</label>
    <select id="formato" name="formato" class="form-select" required>
      {% set opciones = formatos if formatos else ['Papel','Digital'] %}
      {% for op in opciones %}
        {% if item %}
          <option value="{{ op }}" {{ 'selected' if item.formato==op else '' }}>{{ op }}</option>
        {% else %}
          <option value="{{ op }}" {{ 'selected' if loop.first else '' }}>{{ op }}</option>
        {% endif %}
      {% endfor %}
    </select>
    <div class="form-text">Elegí “Digital” para habilitar carga de GOP y PDFs.</div>
  </div>

  <!-- N° copias -->
  <div class="col-md-3">
    <label class="form-label">N° de copias</label>
    <input type="number" name="nro_copias" class="form-control" min="0"
           value="{{ (item.nro_copias if item else '') or '' }}">
  </div>

  <!-- Tipo de trabajo -->
  <div class="col-md-6">
    <label class="form-label">Tipo de trabajo</label>
    <input type="text" name="tipo_trabajo" class="form-control"
           value="{{ (item.tipo_trabajo if item else '') or '' }}">
  </div>

  <!-- N° CPIM -->
  <div class="col-md-6">
    <label class="form-label">N° Expediente CPIM</label>
    <input type="text" name="nro_expediente_cpim" class="form-control"
           value="{{ (item.nro_expediente_cpim if item else '') or '' }}">
  </div>

  <!-- Profesional / Comitente -->
  <div class="col-md-6">
    <label class="form-label">Nombre profesional</label>
    <input type="text" name="nombre_profesional" class="form-control"
           value="{{ (item.nombre_profesional if item else '') or '' }}">
  </div>
  <div class="col-md-6">
    <label class="form-label">Nombre comitente</label>
    <input type="text" name="nombre_comitente" class="form-control"
           value="{{ (item.nombre_comitente if item else '') or '' }}">
  </div>

  <!-- Ubicación -->
  <div class="col-12">
    <label class="form-label">Ubicación</label>
    <input type="text" name="ubicacion" class="form-control"
           value="{{ (item.ubicacion if item else '') or '' }}">
  </div>

  <div class="col-12">
    <label class="form-label">Partida Inmobiliaria</label>
    <input type="text" name="partida_inmobiliaria" class="form-control"
           value="{{ item.partida_inmobiliaria if item }}">
  </div>

  <div class="mb-3">
    <label for="nro_expediente_municipal" class="form-label">Número de Expediente Municipal</label>
    <input type="text" class="form-control" id="nro_expediente_municipal" name="nro_expediente_municipal"
          value="{{ item.nro_expediente_municipal or '' }}">
  </div>

  <!-- ===== Tasas (monto en ARS) ===== -->
  <div class="col-12"><hr class="mt-4"></div>
  <h5 class="mb-2">Tasas</h5>

  <div class="col-md-3">
    <label class="form-label">Tasa de sellado (ARS)</label>
    <input type="text" name="tasa_sellado_monto" class="form-control" inputmode="decimal"
          placeholder="$ 0,00" value="{{ item.tasa_sellado_monto|ars if item and item.tasa_sellado_monto }}">
    <div class="form-text">Ingresá el monto. Acepta 1234.56 o 1.234,56</div>
  </div>

  <div class="col-md-3">
    <label class="form-label">Visado Eléctrica (ARS)</label>
    <input type="text" name="tasa_visado_electrica_monto" class="form-control" inputmode="decimal"
          placeholder="$ 0,00" value="{{ item.tasa_visado_electrica_monto|ars if item and item.tasa_visado_electrica_monto }}">
  </div>

  <div class="col-md-3">
    <label class="form-label">Visado Salubridad (ARS)</label>
    <input type="text" name="tasa_visado_salubridad_monto" class="form-control" inputmode="decimal"
          placeholder="$ 0,00" value="{{ item.tasa_visado_salubridad_monto|ars if item and item.tasa_visado_salubridad_monto }}">
  </div>

  <div class="col-md-3">
    <label class="form-label">Visado Gas (ARS)</label>
    <input type="text" name="tasa_visado_gas_monto" class="form-control" inputmode="decimal"
          placeholder="$ 0,00" value="{{ item.tasa_visado_gas_monto|ars if item and item.tasa_visado_gas_monto }}">
  </div>

  <div class="col-md-3">
    <label class="form-label">Visado Electromecánica (ARS)</label>
    <input type="text" name="tasa_visado_electromecanica_monto" class="form-control" inputmode="decimal"
          placeholder="$ 0,00" value="{{ item.tasa_visado_electromecanica_monto|ars if item and item.tasa_visado_electromecanica_monto }}">
  </div>
  <!-- ===== Fin Tasas ===== -->

  <!-- Estados de pago -->
  <div class="col-md-6">
    <label class="form-label">Estado pago sellado</label>
    <select name="estado_pago_sellado" class="form-select" required>
      {% set opts = estados or ['pendiente','pagado','exento'] %}
      {% set val = (item.estado_pago_sellado if item and item.estado_pago_sellado else 'pendiente') %}
      {% for o in opts %}
        <option value="{{ o }}" {{ 'selected' if val==o else '' }}>{{ o|capitalize }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-6">
    <label class="form-label">Estado pago visado</label>
    <select name="estado_pago_visado" class="form-select" required>
      {% set opts = estados or ['pendiente','pagado','exento'] %}
      {% set val = (item.estado_pago_visado if item and item.estado_pago_visado else 'pendiente') %}
      {% for o in opts %}
        <option value="{{ o }}" {{ 'selected' if val==o else '' }}>{{ o|capitalize }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- Salida -->
  <div class="col-md-4">
    <label class="form-label">Fecha de salida</label>
    <input
      type="date"
      name="fecha_salida"
      class="form-control"
      value="{% if item and item.fecha_salida %}{{ item.fecha_salida.strftime('%Y-%m-%d') }}{% else %}{% endif %}">
  </div>
  <div class="col-md-4">
    <label class="form-label">Persona que retira</label>
    <input type="text" name="persona_retira" class="form-control"
           value="{{ (item.persona_retira if item else '') or '' }}">
  </div>
  <div class="col-md-4">
    <label class="form-label">N° de caja</label>
    <input type="number" name="nro_caja" class="form-control" min="0"
           value="{{ (item.nro_caja if item else '') or '' }}">
  </div>

  <div class="col-md-6">
    <label class="form-label">Ruta carpeta</label>
    <input type="text" name="ruta_carpeta" class="form-control"
           value="{{ (item.ruta_carpeta if item else '') or '' }}">
  </div>

  <!-- WhatsApp -->
  <div class="col-md-3">
    <label class="form-label">WhatsApp profesional</label>
    <input type="text" name="whatsapp_profesional" class="form-control"
           value="{{ (item.whatsapp_profesional if item else '') or '' }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">WhatsApp tramitador</label>
    <input type="text" name="whatsapp_tramitador" class="form-control"
           value="{{ (item.whatsapp_tramitador if item else '') or '' }}">
  </div>

  <!-- ===== Bloque extra SOLO para Formato Digital ===== -->
  <div id="digital-extra" class="col-12" style="display:none;">
    <hr class="mt-4">
    <h5>Datos para trabajos digitales</h5>

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Número de GOP</label>
        <input type="text" name="gop_numero" class="form-control"
               value="{{ (item.gop_numero if item else '') or '' }}">
      </div>

      <div class="col-md-6">
        <label class="form-label">Archivos PDF</label>
        <input type="file" name="pdfs" class="form-control" accept="application/pdf" multiple>
        <div class="form-text">Podés adjuntar uno o varios archivos .pdf</div>
      </div>
    </div>

    {% if item and item.archivos %}
      <div class="mt-3">
        <strong>PDFs ya cargados:</strong>
        <ul class="mb-0">
          {% for a in item.archivos %}
            <li>
              {% if a.public_url %}
                <a href="{{ a.public_url }}" target="_blank" rel="noopener">{{ a.filename }}</a>
              {% else %}
                {{ a.filename }} <small class="text-muted">(no público)</small>
              {% endif %}
              {% if a.size_bytes %}
                <small class="text-muted">— {{ (a.size_bytes / 1024)|round(1) }} KB</small>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </div>
  <!-- ===== Fin bloque Digital ===== -->

  <div class="col-12">
    <button class="btn btn-primary" type="submit">Guardar</button>
    <a class="btn btn-secondary" href="{{ url_for('lista_expedientes') }}">Cancelar</a>
  </div>
</form>

<script>
  function toggleDigital() {
    const sel = document.getElementById('formato');
    const box = document.getElementById('digital-extra');
    if (!sel || !box) return;
    box.style.display = (sel.value === 'Digital') ? '' : 'none';
  }
  document.addEventListener('DOMContentLoaded', toggleDigital);
  document.getElementById('formato').addEventListener('change', toggleDigital);
</script>
{% endblock %}
